# 1. install R packages: metafor, mixmeta, dplyr, ggplot2, splines
library(metafor)
library(mixmeta)
library(dplyr)
library(ggplot2)
library(splines)

# 2. Data preparation
# Expected variables: study_id, effect estimates (HR/RR/OR), lower_CI, upper_CI, and effect modifiers, including lifestyle factors (e.g., social_engagement_mean), follow-up duration (e.g., followup_years), etc.
dat <- read.csv("meta_input.csv")
dat <- dat %>%
    mutate(
    yi = log(effect),
    sei = (log(upper_CI) - log(lower_CI)) / (2 * 1.96),
    vi = sei^2
  )

# 3. Random-effects model (REML + HKSJ) 
res <- rma(yi, vi, data = dat, method = "REML", test = "knha", slab = study_id)
summary(res)
exp(cbind(Estimate = coef(res), confint(res)))

# 4. Heterogeneity (2, I2, and 95% predictive interval)
tau2 <- res$tau2
I2   <- 100 * tau2 / (tau2 + mean(dat$vi))
pred <- predict(res, transf = exp)
cat("τ² =", round(tau2,3), "; I² =", round(I2,1), "%\n")
cat("95% prediction interval (HR):", round(pred$pi.lb,3), "to", round(pred$pi.ub,3), "\n")

# 5. Meta-regression with study-level moderators (primary research question: model lifestyle indicators). Example model: e.g., dat$social_engagement_mean
if ("social_engagement_mean" %in% names(dat)) {
  res_mod <- rma(yi, vi, mods = ~ social_engagement_mean, data = dat,
                 method = "REML", test = "knha")
  summary(res_mod)
}

# 6. Dose–response meta-analyses for continuous lifestyle variables, if data permits
if (all(c("x","yi","vi","study_id") %in% names(dat))) {
  knots <- quantile(dat$x, probs = c(0.10, 0.5, 0.90), na.rm = TRUE)
  Xs <- model.matrix(~ ns(x, knots = knots), data = dat)
  mix_spline <- mixmeta(y = yi, S = vi, X = Xs, id = study_id,
                        data = dat, method = "reml")
  summary(mix_spline)
}

# 7. Sensitivity analyses 
# 7.1.Leave-one-out analysis.
leave1out(res)
# 7.2. Exclude studies that reported ORs or RRs.
if ("measure_type" %in% names(dat)) {
  res_HRonly <- rma(yi, vi, data = filter(dat, measure_type == "HR"),
  method = "REML", test = "knha")
  cat("\nSensitivity Analysis: HR-only studies\n")
  print(summary(res_HRonly))
  exp(cbind(Estimate = coef(res_HRonly), confint(res_HRonly)))
}
# 7.3. Exclude studies with follow-up < 5 years.
if ("followup_years" %in% names(dat)) {
  res_longFU <- rma(yi, vi, data = filter(dat, followup_years >= 5),
                    method = "REML", test = "knha")
  cat("\nSensitivity Analysis: Follow-up ≥ 5 years\n")
  print(summary(res_longFU))
  exp(cbind(Estimate = coef(res_longFU), confint(res_longFU)))
}
# 7.4. Exclude studies at high risk of bias.
if ("risk_bias" %in% names(dat)) {
  res_lowROB <- rma(yi, vi, data = filter(dat, risk_bias != "high"),
                      method = "REML", test = "knha")
  cat("\nSensitivity Analysis: Excluding high risk of bias\n")
  print(summary(res_lowROB))
  exp(cbind(Estimate = coef(res_lowROB), confint(res_lowROB)))
}

#  8. Publication Bias 
funnel(res, xlab = "Log(HR)", main = "Funnel plot")
egger <- regtest(res, model = "rma")   # Egger’s mixed-effects test
print(egger)

tf <- trimfill(res)
summary(tf)
funnel(tf, xlab = "Log(HR)", main = "Trim-and-fill funnel plot")

# 9. Export Summary 
results_summary <- data.frame(
  k = res$k,
  pooled_logHR = coef(res),
  pooled_SE = res$se,
  pooled_HR = exp(coef(res)),
  CI_lower = exp(res$ci.lb),
  CI_upper = exp(res$ci.ub),
  tau2 = tau2,
  I2 = I2
)
write.csv(results_summary, "meta_results_summary.csv", row.names = FALSE)
